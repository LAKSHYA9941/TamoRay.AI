// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  output          = "../generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String     @id @default(uuid()) @db.Uuid
  clerk_id        String     @unique
  email           String     @unique
  tokens          Int        @default(10)
  plan            String     @default("free")
  subscription_id String?
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  jobs            Job[]
  payments        Payment[]
  brandKits       BrandKit[]

  @@map("users")
}

model Job {
  id            String     @id @default(uuid()) @db.Uuid
  userId        String     @map("user_id") @db.Uuid
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompt        String     @db.Text
  imageInputUrl String?    @map("image_input_url")
  stylePreset   String?    @map("style_preset")
  layoutPreset  String?    @map("layout_preset")
  status        String     @default("pending") // pending, processing, completed, failed
  progress      Int        @default(0)
  results       Json?      @db.JsonB
  errorMessage  String?    @map("error_message")
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt   DateTime?  @map("completed_at") @db.Timestamptz(6)
  analytics     Analytics?

  @@map("jobs")
}

model Payment {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeChargeId  String   @unique @map("stripe_charge_id")
  amount          Int
  currency        String   @default("INR")
  tokensPurchased Int      @map("tokens_purchased")
  status          String   @default("pending")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("payments")
}

model BrandKit {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  logoUrl           String?  @map("logo_url")
  colors            Json     @db.JsonB // {primary, secondary, accent}
  fonts             Json     @db.JsonB // {heading, body}
  watermarkSettings Json?    @map("watermark_settings") @db.JsonB
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("brand_kits")
}

model Analytics {
  id           String   @id @default(uuid()) @db.Uuid
  jobId        String   @unique @map("job_id") @db.Uuid
  job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  thumbnailUrl String   @map("thumbnail_url")
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  ctr          Float?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("analytics")
}

// Enable Row Level Security (RLS) - Note: These are SQL commands that need to be run in your database
// You'll need to run these commands in your database after applying migrations
/**
 * -- Enable RLS on all tables
 * ALTER TABLE users ENABLE ROW LEVEL SECURITY;
 * ALTER TABLE jobs ENABLE ROW LEVEL SECURITY;
 * ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
 * ALTER TABLE brand_kits ENABLE ROW LEVEL SECURITY;
 * ALTER TABLE analytics ENABLE ROW LEVEL SECURITY;
 * -- RLS Policies
 * CREATE POLICY users_policy ON users FOR ALL USING (clerk_id = current_setting('app.clerk_user_id'));
 * CREATE POLICY jobs_policy ON jobs FOR ALL USING (user_id IN (SELECT id FROM users WHERE clerk_id = current_setting('app.clerk_user_id')));
 * CREATE POLICY payments_policy ON payments FOR ALL USING (user_id IN (SELECT id FROM users WHERE clerk_id = current_setting('app.clerk_user_id')));
 * CREATE POLICY brand_kits_policy ON brand_kits FOR ALL USING (user_id IN (SELECT id FROM users WHERE clerk_id = current_setting('app.clerk_user_id')));
 * CREATE POLICY analytics_policy ON analytics FOR ALL USING (job_id IN (SELECT id FROM jobs WHERE user_id IN (SELECT id FROM users WHERE clerk_id = current_setting('app.clerk_user_id'))));
 */
