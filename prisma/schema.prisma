// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id              String     @id @default(uuid()) @db.Uuid
  clerk_id        String     @unique
  email           String     @unique
  tokens          Int        @default(10)
  plan            String     @default("free")
  subscription_id String?
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  jobs            Job[]
  payments        Payment[]
  brandKits       BrandKit[]

  @@map("users")
}

model Job {
  id                String     @id @default(uuid()) @db.Uuid
  userId            String     @map("user_id") @db.Uuid
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  prompt            String     @db.Text
  imageInputUrl     String?    @map("image_input_url")
  uploadedImages    Json?      @map("uploaded_images") @db.JsonB // Array of user uploaded image URLs
  stylePreset       String?    @map("style_preset")
  layoutPreset      String?    @map("layout_preset")
  status            String     @default("pending") // pending, queued, processing, completed, failed, cancelled
  progress          Int        @default(0)
  currentStep       String?    @map("current_step")
  eta               Int?       // Estimated time remaining in seconds
  results           Json?      @db.JsonB // Array of 3 generated variations
  selectedVariation Int?       @map("selected_variation") // Index of selected image (0-2)
  parentJobId       String?    @map("parent_job_id") @db.Uuid // For refinement jobs
  parentJob         Job?       @relation("JobRefinements", fields: [parentJobId], references: [id], onDelete: SetNull)
  refinements       Job[]      @relation("JobRefinements")
  replicateId       String?    @unique @map("replicate_id") // Replicate prediction ID
  tokensUsed        Int        @default(1) @map("tokens_used")
  errorMessage      String?    @map("error_message")
  createdAt         DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt       DateTime?  @map("completed_at") @db.Timestamptz(6)
  analytics         Analytics?

  @@index([userId, createdAt])
  @@index([status])
  @@map("jobs")
}

model Payment {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeChargeId  String   @unique @map("stripe_charge_id")
  amount          Int
  currency        String   @default("INR")
  tokensPurchased Int      @map("tokens_purchased")
  status          String   @default("pending")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("payments")
}

model BrandKit {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name             String
  logoUrl          String?  @map("logo_url")
  colors           Json     @db.JsonB // {primary, secondary, accent}
  fonts            Json     @db.JsonB // {heading, body}
  watermarkSettings Json?   @map("watermark_settings") @db.JsonB
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("brand_kits")
}

model Analytics {
  id            String   @id @default(uuid()) @db.Uuid
  jobId         String   @unique @map("job_id") @db.Uuid
  job           Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  thumbnailUrl  String   @map("thumbnail_url")
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  ctr           Float?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("analytics")
}

